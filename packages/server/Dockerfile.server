FROM node:20
WORKDIR /app

COPY package*.json yarn.lock ./
RUN yarn install

COPY . .

# Install Prisma CLI & tsx
RUN yarn global add prisma tsx

# Set the target platform and OpenSSL version
ENV PRISMA_CLI_BINARY_TARGETS=linux-arm64-openssl-3.0.x

# Generate Prisma Client
RUN prisma generate

EXPOSE 3000

CMD if [ "$ENVIRONMENT" = "development" ]; then \
  prisma migrate deploy; \
fi \
&& yarn run dev
